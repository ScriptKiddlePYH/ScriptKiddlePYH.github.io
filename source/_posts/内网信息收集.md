---
title: 内网信息收集
tags: 红蓝对抗
categories: 内网渗透
top: 9
---
# 内网信息收集

## 概述

### 对当前机器角色判断

### 对当前机器所处网络环境的拓扑结构进行分析和判断

### 对当前机器所处区域的判断

## 收集本机信息

### 手动收集信息

- 进一步了解整个域的操作系统版本、软件及补丁安装情况、用户命名方式等

### 自动收集信息

- 通过WMIC命令行工具收集目标机器信息，通过导入ps1脚本

### Empire下的主机信息收集

## 查询当前权限

### 本地普通用户只能查询本机相关信息，不能查询域内信息，而本地管理员用户和域内用户可以查询域内信息。

### 原理：域内的所有查询都是通过域控制器实现的(LDAP协议)，而这个查询需要经过权限认证，当域用户执行查询命令时，会自动使用Kerberos协议进行认证。

## 判断是否存在域

## 探测域内存活主机

### 利用NetBIOS探测内网

- NetBIOS是局域网程序使用的一种应用程序编程接口，为程序提供了请求低级别服务的统一的命令集，为局域网提供了网络及其他特殊功能。NetBIOS的工作流程就是正常的机器名解析查询应答过程，因此推荐优先使用。

### 利用ICMP探测内网

- 对内网中每个IP地址执行ping命令，可快速找出内网所有存活的C段。

### 利用ARP探测内网

- ARP扫描最快，同时准确率也最高。

### 利用TCP/UDP端口探测内网

- ScanLine端口扫描工具

## 扫描域内端口

### 利用telnet命令进行扫描

- 如果想快速探测某台主机的某个常规高位端口，使用telnet命令是最方便的。

### S扫描器

- 支持大网段扫描，特别适合运行在2003以下版本的操作系统中。

### MSF端口扫描

- 大量的内置模块收集信息

### PowerSploit的Invoke-portscan.ps1脚本

### Nishang的Invoke-PortScan模块

### 端口Banner信息

- 获取Banner信息后，可以在漏洞库中查找对应的CVE编号的POC、EXP，从而有针对性地进行安全加固。

## 收集域内基础信息

### 确定了当前内网拥有的域，且所控制的主机在域内，就可以进行域内相关信息的收集了。

## 获取域内的用户和管理员信息

### 查询所有域用户列表

### 查询域管理员用户组

## 定位域管理员

### 定位概述

- 在网络攻击测试中，获取域内一个支点后，需要获取管理员权限。当计算机加入域后，会默认给域管理员组赋予本地系统管理员权限。也就是说系统会自动将域管理员组添加到本地系统管理员组中。
- 定位渠道

	- 日志和会话

### 常用域管理员定位工具

- psloggedon.exe
- PVEFindADUser.exe
- netsess.exe
- hunter
- NetView

## 查找域管理进程

### 本机检查

### 查询域控制器的域用户会话

- 原理是：在域控制器中查询域用户会话列表，并将其与域管理员列表进行交叉引用，从而得到域管理会话的系统列表。

### 查询远程系统中运行的任务

- 条件是目标机器在域系统中是通过共享的本地管理员账户运行的

### 扫描远程系统的NetBIOS信息

## 利用PowerShell收集域内信息

## 域内分析工具BloodHound

## 敏感数据的防护

### 资料、数据、文件的定位流程

- 定位内部人事组织结构
- 在内部人事组织结构中寻找需要监视的人员
- 定位相关人员的机器
- 监视相关人员存放文档的位置
- 列出存放文档的服务器的目录

### 核心业务机器及敏感信息防护

- 高级、系统管理人员，财务人员计算机
- 产品管理系统服务器
- 办公系统服务器
- 财务应用系统服务器
- 核心产品源码服务器
- 数据库服务器
- 文件、共享服务器
- 电子邮件服务器
- 网络监控系统服务器

### 应用于文件形式信息的防护

- 包括一些应用的配置文件、敏感文件、密码、远程连接、员工账号、电子邮箱等

## 分析域内网段划分情况及拓扑结构

### 基础的Web架构

- ASP+Access+IIS 5.0/6.0+Windows Server 2003
- ASPX+MSSQL+IIS 7.0/7.5+Windows Server 2008
- PHP+MYSQL+IIS
- PHP+MYSQL+Apache
- PHP+MYSQL+Nginx
- JSP+MYSQL+Nginx
- JSP+MSSQL+Tomcat
- JSP+Oracle+Tomcat

### 域内网段划分

- DMZ

	- 这个区域不是严格意义上的内网，访问控制策略配置严格这内网能访问DMZ，DMZ不能访问外网

- 办公区

	- 安全防护不高，一般攻击者会使用社会工程手段拿下这个网段

- 核心区

	- 攻击者通过分析服务器上运行的服务和进程，可以推断出目标主机使用的运维监控管理系统和安全防护体系(横向移动优先找这些主机)

*XMind - Trial Version*