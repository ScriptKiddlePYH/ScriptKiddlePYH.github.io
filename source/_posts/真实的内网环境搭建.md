---
title: 真实的内网环境搭建
tags: 红蓝对抗
categories: 内网渗透
top: 14
---
## 网络拓扑图及通信原理
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320230449202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
假如我们的笔记本代表我们的宿主机Kali，旁边的是我们自己公司的防火墙，云代表互联网，对面的是对面公司的防火墙和内网服务器，分别是win7和Windows Server2003。

现在我们要对其内网进行渗透攻击，那么我们就必须要获得对面主机反弹回来的meterpreter shell，我们有两种方式，一种是通过VPS代理的方式接收反弹回来的shell；另一种是通过设置防火墙的NAT映射，将IP地址进行映射从而接收反弹的shell连接。
<!--more-->
## 环境搭建
首先我们先安装win7和windows server2003，并添加一个VMnet2虚拟网络，VMnet2和VMnet1的IP地址设置为动态获得。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320231302827.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
**windows7**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233341719.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
**windows server2003**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233413526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
**Kali**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233447842.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
<!--more-->

然后安装monowall软路由防火墙，这节必须跟着步骤一步步来，不然很难配置好。(反正我就折腾了一天 ╮(╯▽╰)╭)

这是monowall的下载地址，我们要下载的是iso镜像文件
[https://archiveos.org/monowall/](https://archiveos.org/monowall/)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320231702299.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
然后新建虚拟机，选择FreeBSD和更早的版本(这里最好是选32位的)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320231847317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
![在这里插入图片描述](https://img-blog.csdnimg.cn/202103202319019.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
新建完成后，跟着这位大佬的操作一步步来，因为太多细节了，这里也说不完，配置好的mono01和mono02分别如下图所示
[https://blog.csdn.net/tluio/article/details/81292992](https://blog.csdn.net/tluio/article/details/81292992)

**mono01**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320232817531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233238948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)


**mono02**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320232851327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233253742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)

tips：这里稍微提醒下就是，当我们安装完成后，必须把安装光盘弹出，要不然会读取失败

## 环境配置
首先是对我们自己公司的防火墙也就是**mono01**进行配置，LAN那个保持默认就好，我们得添加NAT规则和外网转发策略
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320233950438.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
取消掉这个选项，因为他屏蔽了类似192.168的网段的连接，点击save
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320234159252.png)

NAT规则的设置，设置完成记得点保存！！！
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320234427762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
然后接着我们设置**mono02**的配置，mono02的配置较简单，只需将Block选项取消掉即可
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320234644747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
为了检验最后的效果，我们在kali上开启一个服务器，监听的端口号为4444
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320234947351.png)
在win7上访问mono01的公网IP，显示连接成功即搭建成功！！！
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210320235029633.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)


