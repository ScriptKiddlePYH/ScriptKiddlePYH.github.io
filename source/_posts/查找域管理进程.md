---
title: Powershell收集域内信息
tags: 内网渗透
categories: 红队对抗
top: 3
---

## 前言
在渗透测试中，一个典型的域权限提升过程，通常围绕着收集明文凭据或通过mimikatz提权等方法，在获取了管理员权限的系统中寻找域管理员登录进程，进而收集域管理员的凭据。如果内网环境非常复杂，渗透测试人员无法立即在拥有权限的系统中获得域管理员进程，那么通常采用的方法是：在跳板机之间跳转，直至获得域管理员权限，同时进行一些分析工作，进而找到渗透测试的路径。

现在我们来假设一种情况：渗透测试人员在某个内网环境中获得一个域普通用户的权限，首先通过各种方法获得当前服务器的本地管理员权限，然后分析当前服务器的用户登录列表及会话信息，知道哪些用户登录了这台服务器。如果渗透测试人员通过分析发现，可以获取权限的登录用户都不是域管理员账户，同时没有域管理员组中的用户登录这台服务器，就可以使用另一个账户并寻找账户在内网的哪台机器上具有管理权限，再枚举这台机器上的用户，然后继续进行渗透测试，直至找到一个可以获取域管理员权限的有效路径为止。

## 思路

> **net group "Domain Admins" /domain：获取域管理员列表**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307211234765.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)

> **tasklist /v：列出本机的所有进程及进程用户**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307211423315.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTAwNzA3Mw==,size_16,color_FFFFFF,t_70)
从这里可以看到域管理员都有哪些进程，如果能找到，这将对后面窃取令牌有很大的帮助。

> **net group "Domain Controllers" /domain：查询域控制器列表**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307211639715.png)

> **交叉引用域管理员列表与活动会话列表**

对域管理员列表和活动会话列表进行交叉引用，可以确定哪些IP地址有活动域令牌。

首先我们先在域控上连接其中一台远程主机
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307212138384.png)
在远程目标机器上用powershell能看到连接的主机目标IP(一定要是管理员权限)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307212637526.png)
然后我们将域控制器列表添加到dcs.txt中，将域管理员列表添加到admins.txt中
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307212828102.png)
然后运行一下脚本，会在当前目录下生成一个文本文件sessions.txt

```powershell
FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i && @netsess -h %i 2>null >sessions.txt && FOR /F %a in (admins.txt) DO @type sessions.txt | @findstr /I %a
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307213025308.png)

> **查询远程系统中运行的任务**

如果目标机器在域系统中是通过共享的本地管理员账户运行的，就可以使用下列脚本来查询系统中的管理任务。

```powershell
FOR /F %i in (dcs.txt) DO @echo [+] %i && @tasklist /V /S %i /U user /P password 2>NUL > output.txt && FOR /F %n in (admins.txt) DO @type output.txt | findstr %n > NUL && echo [!] %n was found running a process on %i && pause
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307213500148.png)

> 扫描远程系统的NetBIOS信息

```powershell
for /F %i in (dcs.txt) do @echo [+] Checking %i && nbtstat -A %i 2>NUL >nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307213755137.png)
以下脚本作用类似于nbtscan工具

```powershell
for /F %i in (dcs.txt) do @echo [+] Checking %i && nbtscan -f %i 2>NUL >nbsessions.txt && FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n > NUL && echo [!] %n was found logged into %i
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210307213858148.png)

